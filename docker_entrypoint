#!/bin/bash

# Exit build script on first failure.
set -e

# Exit on unset variable.
set -u

readonly DB_PATH="/app/data/store.db"

# Set litestream configuration
sudo cat > /etc/litestream.yml <<EOF
access-key-id:     "${AWS_ACCESS_KEY_ID}"
secret-access-key: "${AWS_SECRET_ACCESS_KEY}"
region: "${AWS_REGION}"

dbs:
  - path: "${DB_PATH}"
    replicas:
      - url: "${DB_REPLICA_URL}"
EOF

# Restore database from S3
litestream restore "${DB_PATH}"

sudo systemctl restart litestream

# Start server
/app/server
